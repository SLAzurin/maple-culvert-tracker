services:
  watchtower:
    image: ghcr.io/containrrr/watchtower:1.7.1@sha256:6dd50763bbd632a83cb154d5451700530d1e44200b268a4e9488fefdfcf2b038 # latest 1.7.1 Nov 11, 2023
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - --rolling-restart # update running containers strategy
      - --cleanup # auto-remove old image to save disk spaces size
      - --label-enable # instruct watchtower to scan running containers with container labels
      - --api-version # critical cli flag to fix startup api version check
      - "1.44" # override api version semver
      - --scope # instruct watchtower to only update containers with specified scope
      - mctscpdly # scope name
  db16:
    image: postgres:16-alpine
    volumes:
      - mapleculverttracker_pg16_data:/var/lib/postgresql/data
      - ./sqlfiles:/root/sqlfiles
    restart: unless-stopped
    env_file:
      - .env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
  valkey:
    image: valkey/valkey:7.2-alpine
    volumes:
      - mapleculverttracker_valkey_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/redis-cli ping"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
  chartmaker:
    image: ghcr.io/slazurin/maple-culvert-tracker/chartmaker
    restart: unless-stopped
    init: true
    environment:
      - NODE_ENV=production
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=mctscpdly"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'bun -e ''var t=await fetch("http://localhost:3000/chartmaker/ping");if(t.status!==200)throw Error("status not 200");console.log(t.status);''',
        ]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
  periodicredis:
    depends_on:
      valkey:
        condition: service_healthy
        restart: true
    image: ghcr.io/slazurin/maple-culvert-tracker/periodicredis
    restart: unless-stopped
    env_file: .env
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=mctscpdly"
  cron:
    depends_on:
      db16:
        condition: service_healthy
        restart: true
      valkey:
        condition: service_healthy
        restart: true
    image: ghcr.io/slazurin/maple-culvert-tracker/cron
    restart: unless-stopped
    env_file:
      - .env
    init: true
    entrypoint: sh
    command: ["-c", "/usr/sbin/crond -f -c /etc/cron"]
    volumes:
      - mapleculverttracker_valkey_data:/valkey_data
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=mctscpdly"
  traefik:
    depends_on:
      bot:
        condition: service_started
        restart: true
      web:
        condition: service_healthy
        restart: true
    image: traefik:v3
    restart: unless-stopped
    volumes:
      # - traefik.yml:/etc/traefik/traefik.yml # Do not use, since we depend on env variables defined during deployment
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
      - ./traefik:/configs
    ports:
      - 80:80
      # - "8080:8080" # optional
      - 443:443
    command:
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--providers.docker"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/configs/"
      - "--entryPoints.websecure.address=:443"
      - "--certificatesresolvers.lets-encrypt.acme.tlschallenge=true"
      # - "--certificatesresolvers.lets-encrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory" # staging test server
      - "--certificatesresolvers.lets-encrypt.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.lets-encrypt.acme.storage=/letsencrypt/acme.json"
      - "--entryPoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
  bot:
    depends_on:
      db16:
        condition: service_healthy
        restart: true
      chartmaker:
        condition: service_healthy
        restart: true
      valkey:
        condition: service_healthy
        restart: true
    image: ghcr.io/slazurin/maple-culvert-tracker/bot
    healthcheck:
      test:
        [
          "CMD",
          "/http_healthcheck",
          "--url",
          "http://localhost:8080/health",
        ]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    restart: unless-stopped
    env_file: .env
    labels:
      # watchtower
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=mctscpdly"
      # traefik
      - "traefik.enable=true"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.routers.api.rule=Host(`${LETSENCRYPT_HOSTNAME}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=lets-encrypt"
      - "traefik.http.routers.api.service=api-service"
      - "traefik.http.routers.api.tls.options=modern@file"
      - "traefik.http.routers.api.middlewares[0]=hsts-header"
      - "traefik.http.routers.api.middlewares[1]=redirect-to-https"
      - "traefik.http.services.api-service.loadbalancer.server.port=8080"
  web:
    image: ghcr.io/slazurin/maple-culvert-tracker/web
    healthcheck:
      test: ["CMD", "/http_healthcheck", "--url", "http://localhost:8080/"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    init: true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=mctscpdly"
      - "traefik.enable=true"
      - "traefik.http.routers.static.priority=10"
      - "traefik.http.routers.static.rule=Host(`${LETSENCRYPT_HOSTNAME}`) && PathPrefix(`/`)"
      - "traefik.http.routers.static.entrypoints=websecure"
      - "traefik.http.routers.static.tls.certresolver=lets-encrypt"
      - "traefik.http.routers.static.service=static-service"
      - "traefik.http.routers.static.tls.options=modern@file"
      - "traefik.http.routers.static.middlewares[0]=hsts-header"
      - "traefik.http.routers.static.middlewares[1]=redirect-to-https"
      - "traefik.http.services.static-service.loadbalancer.server.port=8080"

volumes:
  mapleculverttracker_pg16_data:
  mapleculverttracker_valkey_data:
  letsencrypt:
